<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#ff6b35">
    <link rel="manifest" href="/static/manifest.json">
    <title>Vibe CBR Reader</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/stylesnew.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <button class="hamburger-btn" onclick="toggleHamburger()" title="Menu">‚â°</button>
            <a href="#/library" class="logo">
                <div class="logo-icon">üìö</div>
                <span class="logo-text">Vibe Reader</span>
            </a>
            <span id="user-header-info" class="user-header-info"></span>
        </div>
        
        <nav class="header-nav">
            <button class="header-btn mobile-icon-only active" id="nav-library" title="Library">
                <span>üìñ</span> <span class="nav-label">Library</span>
            </button>
            <button class="header-btn mobile-icon-only" onclick="routerNavigate('discovery', {})" id="nav-discovery" title="Discover">
                <span>‚ú®</span> <span class="nav-label">Discover</span>
            </button>
            <button class="header-btn mobile-icon-only" onclick="routerNavigate('recent', {})" id="nav-recent" title="Recent">
                <span>üïê</span> <span class="nav-label">Recent</span>
            </button>
            <button class="header-btn mobile-icon-only" onclick="routerNavigate('tags', {})" id="nav-tags" title="Tags">
                <span>üè∑Ô∏è</span> <span class="nav-label">Tags</span>
            </button>
            <div class="search-box" id="header-search-box">
                <span class="search-icon">üîç</span>
                <input type="text" class="search-input" id="searchInput" placeholder="Search titles..." oninput="handleSearch(this.value)">
                <button class="search-scope-btn" id="search-scope-btn" onclick="toggleSearchScope()" title="Toggle search scope">
                    üìç Current
                </button>
                <button class="search-close-btn" onclick="toggleMobileSearch(false)">‚úï</button>
            </div>
            <button class="header-btn mobile-search-toggle" onclick="toggleMobileSearch(true)" title="Search">
                <span>üîç</span>
            </button>
        </nav>

        <!-- Hamburger Menu Dropdown -->
        <div class="hamburger-menu" id="hamburger-menu">
            <!-- Auth Section (Injected here) -->
            <div id="auth-section" class="menu-section"></div>
        </div>
    </header>

    <!-- Main Container -->
    <main class="main-container">
        <!-- Library View -->
        <div id="view-library" class="view active">
            <div class="section-header">
                <div class="header-info">
                    <div class="breadcrumbs-inline" id="breadcrumbs">
                        <span class="breadcrumb-link" onclick="routerNavigate('library', {})">Library</span>
                    </div>
                    <h2 class="section-title">
                        <span id="section-icon">üìö</span>
                        <span id="library-title">Categories</span>
                    </h2>
                    <p class="section-subtitle" id="library-subtitle">Browse your collection</p>
                </div>
                
                <div class="header-controls">
                    <div class="control-group-main">
                        <div class="view-toggle">
                            <button class="view-btn active" data-view="grid" onclick="setViewMode('grid')" title="Grid View">
                                <span>‚äû</span>
                            </button>
                            <button class="view-btn" data-view="list" onclick="setViewMode('list')" title="List View">
                                <span>‚ò∞</span>
                            </button>
                            <button class="view-btn" data-view="detailed" onclick="setViewMode('detailed')" title="Detailed View">
                                <span>‚ñ§</span>
                            </button>
                        </div>
                        <select class="sort-select" id="sort-select" onchange="handleSort(this.value)">
                            <option value="alpha-asc">A-Z</option>
                            <option value="alpha-desc">Z-A</option>
                            <option value="date-added">Date</option>
                            <option value="page-count">Pages</option>
                            <option value="file-size">Size</option>
                            <option value="recent-read">Recent</option>
                        </select>
                    </div>

                    <div class="filters-stack" id="library-filters" style="display: none;">
                        <div class="filter-row-top">
                            <select class="filter-select" id="filter-genre" onchange="handleFilterChange()" style="width: 100%;">
                                <option value="">All Genres</option>
                            </select>
                        </div>
                        <div class="filter-row-bottom">
                            <select class="filter-select" id="filter-status" onchange="handleFilterChange()">
                                <option value="">All Statuses</option>
                            </select>
                            <select class="filter-select" id="filter-read" onchange="handleFilterChange()">
                                <option value="">Any Progress</option>
                                <option value="unread">Unread</option>
                                <option value="reading">In Progress</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                    </div>

                    <div class="control-group-main">
                        <button class="header-btn btn-selection-mode" id="btn-selection-mode" onclick="toggleSelectionMode()" title="Selection Mode">
                            <span>‚òë</span>
                        </button>
                        <button class="header-btn" id="btn-flatten" onclick="toggleFlattenMode()" title="Flatten Library">
                            <span>üìÑ</span>
                        </button>
                        <button class="header-btn" id="btn-toggle-folders" onclick="toggleMobileSidebar()" title="Toggle Folders">
                            <span>üìÅ</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Library Content -->
            <div class="library-layout" id="library-layout">
                <!-- Folder Sidebar -->
                <aside class="folder-sidebar" id="folder-sidebar">
                    <div class="folder-tree" id="folder-tree">
                        <!-- Populated dynamically -->
                    </div>
                </aside>

                <!-- Content Area -->
                <div class="content-area" id="content-area">
                    <!-- Folders Grid -->
                    <div class="folder-grid" id="folder-grid" style="display: none;">
                        <!-- Populated dynamically -->
                    </div>

                    <!-- Comics/Title Cards Container -->
                    <div id="comics-container" class="comics-grid">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading your library...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Summary (moved to bottom) -->
            <div class="stats-summary" id="stats-summary" style="display: none;">
                <div class="stat-item">
                    <span class="stat-value" id="stat-total-comics">0</span>
                    <span class="stat-label">Chapters</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="stat-total-pages">0</span>
                    <span class="stat-label">Pages</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="stat-total-size">0 MB</span>
                    <span class="stat-label">Size</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="stat-reading">0</span>
                    <span class="stat-label">Progress</span>
                </div>
            </div>
        </div>

        <!-- Discovery View -->
        <div id="view-discovery" class="view">
            <div class="section-header">
                <div class="header-info">
                    <h2 class="section-title">
                        <span>‚ú®</span>
                        Discover
                    </h2>
                     <p class="section-subtitle">Explore new additions and personalized suggestions</p>
                </div>
            </div>
            
            <!-- New Additions Section -->
            <div class="discovery-section">
                <div class="discovery-section-header">
                    <h3>üÜï New Additions</h3>
                    <div class="carousel-nav">
                        <button class="carousel-btn prev" onclick="scrollCarousel('new', -1)">‚Üê</button>
                        <button class="carousel-btn next" onclick="scrollCarousel('new', 1)">‚Üí</button>
                    </div>
                </div>
                <div class="carousel-container" id="discovery-new-grid">
                    <div class="loading">Loading...</div>
                </div>
            </div>
            
            <!-- Suggestions Section -->
            <div class="discovery-section">
                <div class="discovery-section-header">
                    <h3>üí° Suggestions</h3>
                    <div class="carousel-nav">
                        <button class="carousel-btn" onclick="refreshSuggestions()" title="Refresh suggestions">üîÑ</button>
                        <button class="carousel-btn prev" onclick="scrollCarousel('suggestions', -1)">‚Üê</button>
                        <button class="carousel-btn next" onclick="scrollCarousel('suggestions', 1)">‚Üí</button>
                    </div>
                </div>
                <div class="carousel-container" id="discovery-suggestions-grid">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Recent View -->
        <div id="view-recent" class="view">
            <div class="section-header">
                <div class="header-with-actions">
                    <div>
                        <h2 class="section-title">
                            <span>üïê</span>
                            Continue Reading
                        </h2>
                        <p class="section-subtitle">Pick up where you left off</p>
                    </div>
                    <button class="btn-secondary" id="btn-purge-history" onclick="confirmPurgeHistory()">
                        <span>üóëÔ∏è</span> Purge History
                    </button>
                </div>
            </div>

            <div id="recent-grid" class="comics-grid">
                <div class="empty-state">
                    <div class="empty-icon">üìñ</div>
                    <div class="empty-title">No recent reads</div>
                    <p>Start reading some comics to see them here!</p>
                </div>
            </div>
        </div>

        <!-- Tags View -->
        <div id="view-tags" class="view">
            <div class="section-header">
                <div class="header-info">
                    <div class="breadcrumbs-inline">
                        <span class="breadcrumb-link" onclick="routerNavigate('library', {})">Library</span> <span class="breadcrumb-separator">‚Ä∫</span> <span class="breadcrumb-current">Tags</span>
                    </div>
                    <h2 class="section-title">
                        <span>üè∑Ô∏è</span>
                        Browse by Tags
                    </h2>
                    <p class="section-subtitle" id="tags-subtitle">Select tags to narrow down your collection</p>
                </div>
                <div class="header-controls">
                    <div class="control-group-main">
                        <div class="view-toggle">
                            <button class="view-btn active" data-view="grid" onclick="setViewMode('grid')" title="Grid View">
                                <span>‚äû</span>
                            </button>
                            <button class="view-btn" data-view="list" onclick="setViewMode('list')" title="List View">
                                <span>‚ò∞</span>
                            </button>
                            <button class="view-btn" data-view="detailed" onclick="setViewMode('detailed')" title="Detailed View">
                                <span>‚ñ§</span>
                            </button>
                        </div>
                    </div>

                    <div class="filters-stack" id="tags-filters" style="display: none;">
                        <div class="filter-row-top">
                            <select class="filter-select" id="tag-filter-genre" onchange="handleTagFilterChange()" style="width: 100%;">
                                <option value="">All Genres</option>
                            </select>
                        </div>
                        <div class="filter-row-bottom">
                            <select class="filter-select" id="tag-filter-status" onchange="handleTagFilterChange()">
                                <option value="">All Statuses</option>
                            </select>
                            <select class="filter-select" id="tag-filter-read" onchange="handleTagFilterChange()">
                                <option value="">Any Progress</option>
                                <option value="unread">Unread</option>
                                <option value="reading">In Progress</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                    </div>

                    <div class="control-group-main">
                        <button class="header-btn btn-selection-mode" id="btn-selection-mode-tags" onclick="toggleSelectionMode()" title="Selection Mode">
                            <span>‚òë</span>
                        </button>
                        <div class="search-box" id="tag-search-container">
                            <span class="search-icon">üîç</span>
                            <input type="text" class="search-input" id="tagSearchInput" placeholder="Filter tags..." style="padding-right: 16px !important;">
                        </div>
                         <button id="btn-show-results" class="btn-primary" onclick="showTagResults()" style="display:none;">
                            Display Results
                         </button>
                    </div>
                </div>
            </div>

            <!-- Selected Tags Bar -->
            <div id="selected-tags-container" class="tags-filter-bar">
                <!-- Selected tags will appear here -->
            </div>

            <!-- Tags Grid -->
            <div id="tags-grid" class="folder-grid tags-view-grid">
                <!-- Tag folders will appear here -->
            </div>

            <!-- Results Grid (Hidden by default) -->
            <div id="tags-results" class="comics-grid" style="display: none;">
                <!-- Matching series will appear here -->
            </div>
        </div>

        <!-- Series Detail View -->
        <div id="view-series" class="view">
            <div class="series-detail" id="series-detail">
                <!-- Populated dynamically -->
            </div>
        </div>

        <!-- Admin Page View -->
        <div id="view-admin" class="view">
            <div class="section-header">
                <h2 class="section-title">
                    <span>‚öôÔ∏è</span>
                    Administration
                </h2>
                <p class="section-subtitle">Library settings, scanning, and user management</p>
            </div>
            
            <div class="admin-container" style="padding: 1rem 2rem;">
                
                <!-- Section 1: Library Metadata -->
                <div style="margin-bottom: 3rem;">
                    <h3 class="section-title" style="margin-bottom: 1.5rem;">üìö Library Metadata</h3>
                    
                    <!-- Scan Controls -->
                    <div class="admin-card" style="background: var(--bg-secondary); border-radius: 12px; padding: 1.5rem; border: 1px solid var(--border); margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 1rem; color: var(--text-primary); font-weight: 600;">Scan Controls</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <button id="btn-scan-incremental" class="btn-primary" style="padding: 0.75rem 1rem; border-radius: 8px; border: none; background: var(--accent); color: white; cursor: pointer; font-weight: 600;">üîÑ Incremental Scan</button>
                            <button id="btn-scan-full" class="btn-danger" style="padding: 0.75rem 1rem; border-radius: 8px; border: none; background: var(--danger); color: white; cursor: pointer; font-weight: 600;">‚ö†Ô∏è Full Re-Scan</button>
                            <button id="btn-scan-thumbnails" class="btn-primary" style="padding: 0.75rem 1rem; border-radius: 8px; border: none; background: var(--accent); color: white; cursor: pointer; font-weight: 600;">üñºÔ∏è Thumbnail Rescan</button>
                            <button id="btn-scan-metadata" class="btn-primary" style="padding: 0.75rem 1rem; border-radius: 8px; border: none; background: var(--accent); color: white; cursor: pointer; font-weight: 600;">üìã Metadata Rescan</button>
                        </div>
                    </div>
                    
                    <!-- Scan Status Panel -->
                    <div id="admin-scan-status" class="admin-card" style="background: var(--bg-secondary); border-radius: 12px; padding: 1.5rem; border: 1px solid var(--border); margin-bottom: 2rem; display: none;">
                        <h4 style="margin-bottom: 1rem; color: var(--text-primary); font-weight: 600;">Scan Status</h4>
                        <div class="progress-bar" style="width: 100%; height: 30px; background: var(--bg-tertiary); border-radius: 15px; overflow: hidden; margin-bottom: 1rem;">
                            <div id="admin-scan-progress-fill" style="width: 0%; height: 100%; background: var(--accent); transition: width 0.3s;"></div>
                        </div>
                        <div style="text-align: center; margin-bottom: 1rem;">
                            <span id="admin-scan-processed">0</span> of <span id="admin-scan-total">0</span> comics processed
                        </div>
                        <div style="text-align: center; margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            Current: <span id="admin-scan-current-file">-</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; font-size: 0.85rem;">
                            <div style="background: var(--bg-tertiary); padding: 0.75rem; border-radius: 8px;">
                                <p style="margin-bottom: 0.5rem; color: var(--text-secondary); font-weight: 600;">Phase 1: Syncing</p>
                                <div style="display: flex; justify-content: space-between;"><span>New:</span> <span id="admin-metric-new" style="color: var(--success);">0</span></div>
                                <div style="display: flex; justify-content: space-between;"><span>Changed:</span> <span id="admin-metric-changed" style="color: var(--accent);">0</span></div>
                                <div style="display: flex; justify-content: space-between;"><span>Deleted:</span> <span id="admin-metric-deleted" style="color: var(--danger);">0</span></div>
                            </div>
                            <div style="background: var(--bg-tertiary); padding: 0.75rem; border-radius: 8px;">
                                <p style="margin-bottom: 0.5rem; color: var(--text-secondary); font-weight: 600;">Phase 2: Processing</p>
                                <div style="display: flex; justify-content: space-between;"><span>Pages:</span> <span id="admin-metric-pages">0</span> <small id="admin-metric-page-err" style="color: var(--danger);">(0 err)</small></div>
                                <div style="display: flex; justify-content: space-between;"><span>Thumbs:</span> <span id="admin-metric-thumbs">0</span> <small id="admin-metric-thumb-err" style="color: var(--danger);">(0 err)</small></div>
                            </div>
                        </div>
                        <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px;">
                            <p>Status: <span id="admin-scan-status-text">Idle</span></p>
                            <p>Started: <span id="admin-scan-started">-</span></p>
                            <p id="admin-scan-completed-container" style="display: none;">
                                Completed: <span id="admin-scan-completed">-</span>
                            </p>
                        </div>
                    </div>
                    
                    <!-- Thumbnail Settings -->
                    <div class="admin-card" style="background: var(--bg-secondary); border-radius: 12px; padding: 1.5rem; border: 1px solid var(--border);">
                        <h4 style="margin-bottom: 1rem; color: var(--text-primary); font-weight: 600;">Thumbnail Settings</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-weight: 600;">Format</label>
                                <select id="thumb-format-select" style="width: 100%; padding: 0.5rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary);">
                                    <option value="webp">WebP</option>
                                    <option value="png">PNG</option>
                                    <option value="jpg">JPG</option>
                                    <option value="best">Pick Best</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-weight: 600;">Quality: <span id="thumb-quality-value">70</span>%</label>
                                <input id="thumb-quality-slider" type="range" min="0" max="100" value="70" style="width: 100%; cursor: pointer;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-weight: 600;">Aspect Ratio</label>
                                <select id="thumb-ratio-select" style="width: 100%; padding: 0.5rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary);">
                                    <option value="663:1024">American (663:1024)</option>
                                    <option value="128:182">Bunko (128:182)</option>
                                    <option value="114:172">Tankobon (114:172)</option>
                                    <option value="257:364">ISO B4 (257:364)</option>
                                    <option value="9:14">MAL (9:14)</option>
                                    <option value="512:713">Mangadex (512:713)</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-weight: 600;">Width: <span id="thumb-width-value">225</span>px</label>
                                <input id="thumb-width-slider" type="range" min="60" max="300" value="225" style="width: 100%; cursor: pointer;">
                            </div>
                        </div>
                        <button id="thumb-save-btn" class="btn-primary" style="padding: 0.75rem 1.5rem; border-radius: 8px; border: none; background: var(--accent); color: white; cursor: pointer; font-weight: 600;">üíæ Save Settings</button>
                    </div>
                </div>
                
                <!-- Section 2: User Management -->
                <div style="margin-bottom: 3rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 class="section-title">üë• User Management</h3>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input id="toggle-require-approval" type="checkbox" style="cursor: pointer;">
                            <span style="color: var(--text-secondary); font-weight: 600;">Require Approval</span>
                        </label>
                    </div>
                    
                    <div class="admin-card" style="background: var(--bg-secondary); border-radius: 12px; overflow: hidden; border: 1px solid var(--border);">
                        <table class="admin-table" style="width: 100%; border-collapse: collapse; text-align: left;">
                            <thead>
                                <tr style="background: var(--bg-tertiary); border-bottom: 1px solid var(--border);">
                                    <th style="padding: 1rem;">Username</th>
                                    <th style="padding: 1rem;">Email</th>
                                    <th style="padding: 1rem;">Role</th>
                                    <th style="padding: 1rem;">Comics Read</th>
                                    <th style="padding: 1rem;">Time Read</th>
                                    <th style="padding: 1rem;">Approved</th>
                                    <th style="padding: 1rem;">Created</th>
                                    <th style="padding: 1rem;">Last Login</th>
                                    <th style="padding: 1rem; text-align: right;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="admin-users-table-body">
                                <!-- Populated dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Section 3: Sequence Gaps -->
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 class="section-title">üï≥Ô∏è Sequence Gaps</h3>
                        <button class="btn-secondary" onclick="loadGapsReport()" style="padding: 0.75rem 1rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text-primary); cursor: pointer; font-weight: 600;">üîÑ Refresh Report</button>
                    </div>
                    <p class="section-subtitle" style="margin-bottom: 1.5rem;">Identify missing chapters or volumes in your collection</p>
                    
                    <div id="admin-gaps-container" class="admin-card" style="background: var(--bg-secondary); border-radius: 12px; padding: 1.5rem; border: 1px solid var(--border);">
                        <div class="empty-state" style="padding: 2rem;">
                            <p>Click "Refresh Report" to scan for gaps.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile View -->
        <div id="view-profile" class="view">
            <div class="section-header">
                <h2 class="section-title">
                    <span>üë§</span>
                    User Profile
                </h2>
                <p class="section-subtitle">Manage your account and view statistics</p>
            </div>
            
            <div class="profile-container" style="padding: 1rem 2rem; display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                <!-- Account Info -->
                <div class="profile-card" style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border);">
                    <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 1.2rem;">üÜî</span> Account Information
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <div style="display: flex; justify-content: space-between; border-bottom: 1px solid var(--border-light); padding-bottom: 0.5rem;">
                            <span style="color: var(--text-secondary);">Username</span>
                            <span id="profile-username" style="font-weight: 600;">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; border-bottom: 1px solid var(--border-light); padding-bottom: 0.5rem;">
                            <span style="color: var(--text-secondary);">Email</span>
                            <span id="profile-email" style="font-weight: 600;">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; border-bottom: 1px solid var(--border-light); padding-bottom: 0.5rem;">
                            <span style="color: var(--text-secondary);">Role</span>
                            <span id="profile-role" style="font-weight: 600; text-transform: capitalize;">-</span>
                        </div>
                    </div>
                    
                    <h3 style="margin-top: 2rem; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 1.2rem;">üîí</span> Change Password
                    </h3>
                    <form onsubmit="handleProfilePasswordChange(event)" id="profile-password-form">
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.85rem; color: var(--text-tertiary);">CURRENT PASSWORD</label>
                            <input type="password" id="profile-current-password" class="search-input" style="width: 100%; padding: 0.8rem; border-radius: 8px;" required>
                        </div>
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.85rem; color: var(--text-tertiary);">NEW PASSWORD</label>
                            <input type="password" id="profile-new-password" class="search-input" style="width: 100%; padding: 0.8rem; border-radius: 8px;" required minlength="6">
                        </div>
                        <div class="form-group" style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.85rem; color: var(--text-tertiary);">CONFIRM NEW PASSWORD</label>
                            <input type="password" id="profile-confirm-password" class="search-input" style="width: 100%; padding: 0.8rem; border-radius: 8px;" required minlength="6">
                        </div>
                        <button type="submit" class="btn-primary" style="width: 100%; padding: 0.8rem; border-radius: 8px;">
                            Update Password
                        </button>
                    </form>
                </div>
                
                <!-- Statistics -->
                <div class="profile-card" style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border);">
                    <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 1.2rem;">üìä</span> Reading Statistics
                    </h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent);" id="stats-comics-started">0</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem;">Comics Started</div>
                        </div>
                        <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);" id="stats-comics-completed">0</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem;">Comics Completed</div>
                        </div>
                        <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent);" id="stats-pages-read">0</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem;">Approx. Pages Read</div>
                        </div>
                        <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent);" id="stats-time-spent">0h</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem;">Time Spent Reading</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1.5rem; background: var(--bg-tertiary); padding: 1.25rem; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                            <span style="font-weight: 600;">Completion Rate</span>
                            <span id="stats-completion-rate" style="color: var(--success); font-weight: 700;">0%</span>
                        </div>
                        <div style="width: 100%; height: 8px; background: var(--bg-secondary); border-radius: 4px; overflow: hidden;">
                            <div id="stats-completion-bar" style="width: 0%; height: 100%; background: var(--success); transition: width 0.5s ease-out;"></div>
                        </div>
                    </div>

                    <div style="margin-top: 2rem;">
                         <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1.2rem;">‚öôÔ∏è</span> Account Actions
                        </h3>
                        <button class="btn-secondary" onclick="confirmPurgeHistory()" style="width: 100%; margin-bottom: 1rem; color: var(--danger); border-color: var(--danger-low);">
                            üóëÔ∏è Clear Reading History
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Selection Action Bar -->
    <div id="selection-action-bar" class="selection-action-bar">
        <div class="selection-info">
            <span id="selection-count">0</span> items selected
        </div>
        <div class="selection-actions">
            <button class="btn-primary" onclick="handleBatchExport()">üì¶ Export as CBZ</button>
            <button class="btn-secondary" onclick="clearSelection()">Cancel</button>
        </div>
    </div>

    <!-- Reader Container -->
    <div id="reader" class="reader-container">
        <div class="reader-header">
            <div class="reader-nav">
                <button class="reader-btn" onclick="history.back()">
                    <span>‚Üê</span> Back
                </button>
            </div>
            <div class="reader-title" id="reader-title">Loading...</div>
            <div class="reader-nav reader-toolbar">
                <button class="reader-btn" id="fullscreen-btn" onclick="readerToggleFullscreen()" title="Toggle Fullscreen">
                    <span>‚õ∂</span>
                </button>
                <button class="reader-btn" id="bookmark-btn" onclick="toggleBookmark()" title="Add bookmark">
                    <span>üîñ</span>
                </button>
                <button class="reader-btn" id="bookmarks-list-btn" onclick="showBookmarksList()" title="View bookmarks">
                    <span>üìë</span>
                </button>
                <button class="reader-btn" onclick="toggleSettings()">
                    <span>‚öôÔ∏è</span> Settings
                </button>
            </div>
        </div>

        <div class="reader-content">
            <div class="reader-viewport" id="reader-viewport">
                <div class="click-zone prev" id="click-zone-prev"></div>
                <div class="click-zone middle" id="click-zone-middle"></div>
                <div id="reader-pages" class="reader-pages">
                    <div id="reader-loading" class="reader-loading">
                        <div class="spinner"></div>
                    </div>
                    <img id="reader-image" class="reader-image" src="" alt="Comic page">
                </div>
                <div class="click-zone next" id="click-zone-next"></div>
            </div>
        </div>

        <div id="reader-scrubber" class="reader-scrubber"></div>

        <div id="auto-advance-bar" class="auto-advance-container">
            <div class="auto-advance-label">AutoAdvance</div>
            <div class="auto-advance-progress">
                <div id="auto-advance-fill" class="auto-advance-fill"></div>
            </div>
        </div>

        <div class="reader-footer">
            <button class="reader-btn footer-nav-btn prev-chapter" id="footer-prev-chapter" onclick="navigateReaderComic('prev')" title="Previous Chapter">
                <span>‚èÆ</span>
            </button>
            <button class="reader-btn" onclick="prevPage()">‚Üê Prev</button>
            <span class="page-indicator" id="page-indicator">1 / 1</span>
            <div class="progress-container">
                <input type="range" class="progress-slider" id="progress-slider" min="0" max="100" value="0" oninput="handleSliderInput(this.value)" onchange="jumpToPage(this.value)">
                <div id="reader-tooltip" class="reader-tooltip"></div>
            </div>
            <button class="reader-btn" onclick="nextPage()">Next ‚Üí</button>
            <button class="reader-btn footer-nav-btn next-chapter" id="footer-next-chapter" onclick="navigateReaderComic('next')" title="Next Chapter">
                <span>‚è≠</span>
            </button>
        </div>

        <!-- Settings Panel -->
        <div class="settings-panel" id="settings-panel">
            <div class="settings-title">Reader Settings</div>
            
            <div class="setting-group horizontal">
                <label class="setting-label">E-Reader</label>
                <div class="setting-options">
                    <button class="setting-btn" id="reader-ereader-on" onclick="toggleEReader()">üëì On</button>
                    <button class="setting-btn" id="reader-ereader-off" onclick="toggleEReader()">üï∂Ô∏è Off</button>
                </div>
            </div>

            <div class="setting-group horizontal">
                <label class="setting-label">Theme</label>
                <div class="setting-options">
                    <button class="setting-btn" id="reader-theme-dark" onclick="toggleTheme()">üåô Dark</button>
                    <button class="setting-btn" id="reader-theme-light" onclick="toggleTheme()">‚òÄÔ∏è Light</button>
                </div>
            </div>

            <div class="setting-group horizontal">
                <label class="setting-label">Direction</label>
                <div class="setting-options">
                    <button class="setting-btn active" data-setting="direction" data-value="ltr" onclick="setSetting('direction', 'ltr')">
                        ‚û°Ô∏è LTR
                    </button>
                    <button class="setting-btn" data-setting="direction" data-value="rtl" onclick="setSetting('direction', 'rtl')">
                        ‚¨ÖÔ∏è RTL
                    </button>
                </div>
            </div>

            <div class="setting-group horizontal">
                <label class="setting-label">Display</label>
                <div class="setting-options">
                    <button class="setting-btn active" data-setting="display" data-value="single" onclick="setSetting('display', 'single')">
                        üìÑ 1P
                    </button>
                    <button class="setting-btn" data-setting="display" data-value="double" onclick="setSetting('display', 'double')">
                        üìñ 2P
                    </button>
                    <button class="setting-btn" data-setting="display" data-value="long" onclick="setSetting('display', 'long')">
                        üìú Long
                    </button>
                </div>
            </div>

            <div class="setting-group horizontal">
                <label class="setting-label">Zoom</label>
                <div class="setting-options">
                    <button class="setting-btn active" data-setting="zoom" data-value="fit" onclick="setSetting('zoom', 'fit')">
                        üî≤ W+H
                    </button>
                    <button class="setting-btn" data-setting="zoom" data-value="width" onclick="setSetting('zoom', 'width')">
                        ‚ÜîÔ∏è W
                    </button>
                    <button class="setting-btn" data-setting="zoom" data-value="height" onclick="setSetting('zoom', 'height')">
                        ‚ÜïÔ∏è H
                    </button>
                </div>
            </div>

            <div class="setting-group" style="margin-bottom: 24px;">
                <div class="filters-header-compact">
                    <span style="font-size: 0.9rem; font-weight: 600;">Visual Filters</span>
                    <button class="setting-btn" style="padding: 4px 12px; font-size: 0.75rem; font-weight: 600; flex: none; min-width: auto; width: auto;" onclick="resetAllFilters()">Reset All</button>
                </div>

                <div class="setting-group horizontal" style="padding: 4px 0;">
                    <label class="setting-label" style="flex: 0 0 80px;">Brightness</label>
                    <input type="range" min="0.2" max="1.5" step="0.05" value="1.0" class="progress-slider" oninput="setSetting('brightness', this.value, false)" onchange="setSetting('brightness', this.value, true)" id="brightness-slider">
                </div>

                <div class="setting-group horizontal" style="padding: 4px 0;">
                    <label class="setting-label" style="flex: 0 0 80px;">Contrast</label>
                    <input type="range" min="0.2" max="2.0" step="0.05" value="1.0" class="progress-slider" oninput="setSetting('contrast', this.value, false)" onchange="setSetting('contrast', this.value, true)" id="contrast-slider">
                </div>

                <div class="setting-group horizontal" style="padding: 4px 0;">
                    <label class="setting-label" style="flex: 0 0 80px;">Color</label>
                    <input type="range" min="0" max="3.0" step="0.1" value="1.0" class="progress-slider" oninput="setSetting('saturation', this.value, false)" onchange="setSetting('saturation', this.value, true)" id="saturation-slider">
                </div>

                <div class="setting-group horizontal" style="padding: 4px 0;">
                    <label class="setting-label" style="flex: 0 0 80px;">Invert</label>
                    <input type="range" min="0" max="1" step="0.05" value="0" class="progress-slider" oninput="setSetting('invert', this.value, false)" onchange="setSetting('invert', this.value, true)" id="invert-slider">
                </div>

                <div class="setting-group" style="padding: 4px 0; margin-bottom: 0;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <label class="setting-label" style="flex: 0 0 80px; margin-bottom: 0;">Tone</label>
                        <input type="range" min="0" max="1" step="0.05" value="0" class="progress-slider" oninput="setSetting('toneValue', this.value, false)" onchange="setSetting('toneValue', this.value, true)" id="toneValue-slider" style="flex: 1;">
                    </div>
                    <div class="setting-options" style="margin-left: 96px; margin-top: 8px; justify-content: flex-start;">
                        <button class="setting-btn" style="padding: 2px 8px; font-size: 0.65rem; max-width: 60px;" id="tone-mode-sepia" onclick="setSetting('toneMode', 'sepia')">Sepia</button>
                        <button class="setting-btn" style="padding: 2px 8px; font-size: 0.65rem; max-width: 60px;" id="tone-mode-grayscale" onclick="setSetting('toneMode', 'grayscale')">Gray</button>
                    </div>
                </div>
            </div>

            <div class="setting-group">
                <label class="setting-label">Auto-Advance</label>
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <button class="setting-btn" id="auto-advance-toggle" onclick="toggleAutoAdvance()" style="flex: 1;">
                        ‚ñ∂ Start Auto-Advance
                    </button>
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 0.8rem; color: var(--text-secondary); min-width: 60px;">Interval:</span>
                    <input type="range" min="3" max="60" step="1" value="10" class="progress-slider" oninput="setSetting('autoAdvanceInterval', this.value, false)" onchange="setSetting('autoAdvanceInterval', this.value, true)" id="autoAdvanceInterval-slider" style="flex: 1;">
                    <span id="autoAdvanceInterval-value" style="font-size: 0.8rem; color: var(--text-secondary); min-width: 30px;">10s</span>
                </div>
            </div>

            <div class="setting-group">
                <label class="setting-label">Keyboard Shortcuts</label>
                <div style="font-size: 0.8rem; color: var(--text-tertiary); line-height: 1.8;">
                    <div>‚Üê / A - Previous page</div>
                    <div>‚Üí / D / Space - Next page</div>
                    <div>Shift + ‚Üê - Previous chapter</div>
                    <div>Shift + ‚Üí - Next chapter</div>
                    <div>F - Fullscreen</div>
                    <div>B - Toggle bookmark</div>
                    <div>ESC - Close reader</div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <!-- Progress Modal -->
    <div id="progress-modal" class="modal-overlay" style="display: none; z-index: 10001;">
        <div class="modal" style="max-width: 400px; padding: 2.5rem; border: 1px solid var(--accent);">
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <h2 id="progress-title" style="margin-bottom: 0.5rem; color: var(--accent);">Exporting...</h2>
                <p id="progress-subtitle" style="color: var(--text-secondary); font-size: 0.9rem;">Preparing your manga archive</p>
            </div>
            
            <div class="progress-bar-container" style="width: 100%; height: 12px; background: var(--bg-tertiary); border-radius: 6px; overflow: hidden; margin-bottom: 1rem;">
                <div id="progress-bar-fill" style="width: 0%; height: 100%; background: var(--accent); transition: width 0.3s ease-out;"></div>
            </div>
            
            <div id="progress-status" style="text-align: center; font-weight: 600; font-size: 1.1rem; margin-bottom: 0.5rem;">0%</div>
            <div id="progress-detail" style="text-align: center; font-size: 0.8rem; color: var(--text-tertiary); margin-bottom: 1.25rem;">Please wait while we pack your files.</div>
            
            <div id="disk-info" style="margin-bottom: 1.5rem; padding: 0.75rem; background: var(--bg-tertiary); border-radius: 8px; font-size: 0.75rem; display: none;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                    <span style="color: var(--text-tertiary);">Temp Disk Space:</span>
                    <span id="disk-free" style="font-weight: 600;">- GB Free</span>
                </div>
                <div style="width: 100%; height: 4px; background: var(--bg-secondary); border-radius: 2px; overflow: hidden;">
                    <div id="disk-bar-fill" style="width: 0%; height: 100%; background: var(--text-tertiary); opacity: 0.5;"></div>
                </div>
            </div>
            
            <div style="display: flex; justify-content: center;">
                <button class="btn-secondary" onclick="handleCancelExport()" style="width: 100%; border-color: var(--danger-low); color: var(--danger);">
                    Cancel Export
                </button>
            </div>
        </div>
    </div>

    <!-- Forced Password Change Modal -->
    <div id="forced-password-modal" class="modal-overlay" style="display: none; z-index: 10000; background: rgba(0,0,0,0.9); backdrop-filter: blur(5px);">
        <div class="modal-content" style="max-width: 400px; padding: 2.5rem; border-radius: 16px; border: 1px solid var(--accent);">
            <div style="text-align: center; margin-bottom: 2rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üîê</div>
                <h2 style="margin-bottom: 0.5rem; color: var(--accent);">Security Update Required</h2>
                <p style="color: var(--text-secondary); font-size: 0.95rem;">You are using a default or temporary password. For your security, you must change it before continuing.</p>
            </div>
            
            <form onsubmit="handleForcedPasswordChange(event)" id="forced-password-form">
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-size: 0.85rem; color: var(--text-tertiary);">NEW PASSWORD</label>
                    <input type="password" id="forced-new-password" class="search-input" style="width: 100%; padding: 0.8rem; border-radius: 8px;" required minlength="6" placeholder="At least 6 characters">
                </div>
                <div class="form-group" style="margin-bottom: 2rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-size: 0.85rem; color: var(--text-tertiary);">CONFIRM NEW PASSWORD</label>
                    <input type="password" id="forced-confirm-password" class="search-input" style="width: 100%; padding: 0.8rem; border-radius: 8px;" required minlength="6" placeholder="Repeat new password">
                </div>
                
                <button type="submit" class="btn-primary" style="width: 100%; padding: 1rem; border-radius: 8px; font-weight: 600; font-size: 1rem;">
                    Update Password & Continue
                </button>
            </form>
        </div>
    </div>

    <script src="/static/js/ui-utils.js"></script>
    <script type="module" src="/static/js/main.js"></script>
</body>
</html>
